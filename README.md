Flaws from [https://www.owasp.org/index.php/Top_10_2013-Top_10](https://www.owasp.org/index.php/Top_10_2013-Top_10)

Exercise related to course on [https://cybersecuritybase.github.io](https://cybersecuritybase.github.io)

Credantials for login forms: ted, president

To run the project one has to run command `mvn spring-boot:run` in the root after installing Maven and JDK8.

# A10-UnvaliAdated Redirects and Forwards

## How the flaw can be identified?

### Owasp Zap
1. Start Owasp Zap
2. Start the application
3. Configure your browser to use the Zap proxy
4. Go to address localhost:8080/form in the browser
5. Send a signup with the ui
6. Go to the Zap and look for messages under site http://localhost:8080
7. Choose the most recent message named GET:formSave(address,name,redirect)
8. Open active scan dialog for the message
9. Start the scan with default options
10. Look for Alerts tab
11. There should be "External Redirect" alerts
12. Look for the related POST message (Request)
13. Identify the redirect parameter with replaced address
14. Copy the url of the GET (e.g.http://localhost:8080/formSave?name=test&address=test&redirect=http%3A%2F%2F4728989909065774721.owasp.org) and replace the redirect address with e.g. https://www.owasp.org/index.php/Top_10_2013-A10-Unvalidated_Redirects_and_Forwards
15. Copy the modified address to your browser and test it out.

## How the flaw can be fixed?
Do not use redirect-parameters on the first hand. And if it's really needed to use redirect-parameters, then the parameters should be whitelisted. Whitelisted so that in each redirect only explicitly allowed addresses are allowed.

In code level redirect parameter should be removed from form-view. Also in signupcontrollers submitForm-method redirect parameter is not needed and should be removed. Or whitelisted.

Also using GET verb for submitting data from the form is bad. Using GET in the form (and in the back end) makes it possible to use the form page for redirection attacks.

# A3-Cross-Site Scripting (XSS)

## How the flaw can be identified?

### Manual way
This one can be identified by submitting e.g. script `<script>alert("muahaha")</script>` to name or address or both on the form.

### Owasp Zap
1. Start Owasp Zap
2. Make sure there's some fuzzing databases installed in your zap: E.g. add-ons -> FuzzDB files
3. Start the application
4. Configure your browser to use the Zap proxy
5. Go to address localhost:8080/form in the browser
6. Send a signup with the ui
7. Go to the Zap and look for messages under site http://localhost:8080
8. Choose the most recent message named GET:formSave(address,name,redirect)
9. Check out the request and select a parameter you sent
10. Second click with mouse on selected parameter
11. Select Fuzz
12. Click Payloads
13. Add -> File Fuzzers from the top -> fuzzdb -> attack -> xss
14. Click Add
15. Click Ok
16. Go to options tab -> Enable "Follow Redirects" from the bottom
17. Click Start Fuzzer
18. Enjoy
19. Order the results by State and find out some reflected results
20. Try few by hand
21. And if you want to be victim of all the buzzes, go to localhost:8080/signups

## How the flaw can be fixed?
There should be some basic sanitazing for the parameters in back end. For name and address only alphabets and numbers could be allowed.

Also escaping all html by default could be helpful. It's actually difficult at first to put non escaped string on page generated by spring + thymeleaf. Make sure that all data from models are escaped when delivered on html page. Avoid with thymeleaf using utext: `<p th:utext="${name}">name</p>`.

# A8-Cross-Site Request Forgery (CSRF)

## How the flaw can be identified?
Uri /signups should be known. By reading the signups page source one can find out the uri which is used for deleting all signups (and http verb used (GET)).

Zap can be used to find out that there's no csrf token in the GET request for deleting all signups:

1. Start Owasp Zap
2. Start the application
3. Configure your browser to use the Zap proxy
4. Go to address localhost:8080/sigups in the browser
5. Log in if needed (ted, president)
6. Click the button on the bottom
7. Go to the Zap and look for messages under site http://localhost:8080
8. Check out the message GET:delete under signups
9. There should not be any csrf tokens in the request

## Testing the flaw
At first add some signups in localhost:8080/form. Then make sure that sigups are submitted on localhost:8080/signups (ted, president). Then go to localhost:8080/csrf. Then go again to localhost:8080/signups. All signups should be gone.

## How the flaw can be fixed?
At first. Do not use GET for anything changing or deleting data. GET should be [idempotent](https://en.wikipedia.org/wiki/Idempotence) and [safe](https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Safe_methods). So switch GET to DELETE on signups pages form. Back end method deleteSignups should be also switched to use DELETE. Spring/thymeleaf generates the token for you automagically when e.g. DELETE verb is used. localhost:8080/csrf doesn't work anymore.

# A4-Insecure Direct Object References

## How the flaw can be identified?

### Owasp Zap
1. Start Owasp Zap
2. Start the application
3. Configure your browser to use the Zap proxy
4. Go to address localhost:8080/form in the browser
5. In the zap open the Params tab
6. Look if there's already param named id
7. Submit a signup via form
8. Look carefully if param named id alters or appears in the zaps Params tab
9. There should be param called id
10. Second click it and select Search
11. Spot the param from Request done earlier
12. Add more signups via form if needed.
13. Test some different values for param id in uri http://localhost:8080/done?id=3
14. All signups are readable for everyone

## How the flaw can be fixed?
In Spring one should use method `addFlashAttribute` instead of `addAttribute` in SignupControllers method submitForm. When the attribute is added in `redirectAttributes.addAttribute("id", s.getId());` way, the attribute is attached straight in the uri. When `addFlashAttribute` method is used, the attribute is not even delivered to the client. Instead it is stored in a FlashMap in the server [http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/support/RedirectAttributes.html](http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/support/RedirectAttributes.html) [http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/FlashMap.html](http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/FlashMap.html).

If `addFlashAttribute` were used in the submitForm method, then method done method should be also modified to use flash attributes.

One possible solution could be to store the id in a session to be used in done method.

# A1-Injection

## How the flaw can be identified?
The flaw can be found by reading carefully [https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OTG-INPVAL-005)#Standard_SQL_Injection_Testing](https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OTG-INPVAL-005)#Standard_SQL_Injection_Testing) and then testing carefully differing inputs. Checking database rows now and then between input checkings is essential.

There is one input form in the app. It's on form page. If there were no parameter sanitization at all and pure sql were used, then the sql used to insert the data could be easily guessed [http://www.w3schools.com/sql/sql_insert.asp](http://www.w3schools.com/sql/sql_insert.asp).

The flaw can be identified by inserting string `', ''); DELETE FROM signup WHERE 1=1; INSERT INTO signup (name, address) VALUES ('muahaha` for name in the form and then going (after app crash) to localhost:8080/signups (ted, president)

Tools like sqlmap or the zap could be used for this, but it looks like these are more powerful in situations where something is queried from the database, not inserted. In the zap buzzing parameters with sql injection DBs is one potential strategy to find vulnerabilities.

## How the flaw can be fixed?
Just do not use pure sql (at least without parameterization) if it isn't really needed for some reason. E.g. in Spring where hibernate + jpa is in use it's rather difficult to do sql injections. Parameterization and sanitization is done automagically.